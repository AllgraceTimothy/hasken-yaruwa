{% extends "base.html" %}
{% load static %}

{% block title %}Set Password - Hasken Yaruwa{% endblock %}

{% block content %}
<div style="
    max-width: 500px;
    margin: 0 auto;
    padding: 2rem 1rem;
    min-height: 80vh;
    display: flex;
    align-items: center;
    justify-content: center;
">
    <div class="fade-in" style="
        width: 100%;
    ">
        <!-- Logo/Brand Header -->
        <div style="
            text-align: center;
            margin-bottom: 2.5rem;
        ">
            <div style="
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 70px;
                height: 70px;
                background: linear-gradient(135deg, #006747 0%, #00563a 100%);
                color: #FFD700;
                border-radius: 50%;
                margin-bottom: 1.5rem;
                font-size: 2rem;
                font-weight: bold;
                box-shadow: 0 4px 12px rgba(0, 103, 71, 0.2);
            ">
                üîê
            </div>
            <h1 style="
                color: #006747;
                font-size: 2rem;
                margin-bottom: 0.5rem;
            ">
                Set Your Password
            </h1>
            <p style="
                color: #2F4F4F;
                font-size: 1rem;
                opacity: 0.9;
            ">
                Create a secure password for your Hasken Yaruwa account
            </p>
        </div>

        <!-- Password Set Card -->
        <div class="scale-in" style="
            background-color: white;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            padding: 2.5rem;
            border-top: 5px solid #006747;
        ">
            <!-- Password Requirements -->
            <div style="
                background-color: #F8F9FA;
                padding: 1.5rem;
                border-radius: 10px;
                margin-bottom: 2rem;
                border-left: 4px solid #FFD700;
            ">
                <div style="
                    display: flex;
                    align-items: center;
                    gap: 0.8rem;
                    margin-bottom: 1rem;
                ">
                    <div style="
                        background-color: #FFD700;
                        color: #006747;
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 1rem;
                        font-weight: bold;
                    ">!</div>
                    <h3 style="
                        color: #006747;
                        font-size: 1.1rem;
                        margin: 0;
                    ">Password Requirements</h3>
                </div>
                <ul style="
                    color: #2F4F4F;
                    margin: 0;
                    padding-left: 1.2rem;
                    font-size: 0.9rem;
                    line-height: 1.6;
                ">
                    <li>At least 8 characters long</li>
                    <li>Include uppercase and lowercase letters</li>
                    <li>Include at least one number</li>
                    <li>Include at least one special character</li>
                </ul>
            </div>

            <!-- Password Set Form -->
            <form method="post" id="passwordForm">
                {% csrf_token %}
                
                <!-- Form Errors -->
                {% if form.errors %}
                <div style="
                    background-color: #FFE6E6;
                    color: #D32F2F;
                    padding: 1rem;
                    border-radius: 8px;
                    margin-bottom: 1.5rem;
                    border-left: 4px solid #D32F2F;
                ">
                    <div style="
                        display: flex;
                        align-items: flex-start;
                        gap: 0.8rem;
                    ">
                        <div style="
                            font-size: 1.2rem;
                            flex-shrink: 0;
                        ">‚ö†Ô∏è</div>
                        <div>
                            <div style="
                                font-weight: 600;
                                margin-bottom: 0.3rem;
                            ">Please fix the following errors:</div>
                            <ul style="
                                margin: 0;
                                padding-left: 1.2rem;
                                font-size: 0.9rem;
                            ">
                                {% for field in form %}
                                    {% for error in field.errors %}
                                        <li>{{ field.label }}: {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Password Fields -->
                <div style="margin-bottom: 2rem;">
                    {% for field in form %}
                    <div style="margin-bottom: 1.5rem;">
                        <label for="{{ field.id_for_label }}" style="
                            display: block;
                            color: #006747;
                            font-weight: 600;
                            margin-bottom: 0.5rem;
                            font-size: 0.95rem;
                        ">
                            {% if field.name == 'new_password1' %}
                                <span style="color: #FFD700;">üîë</span> New Password
                            {% elif field.name == 'new_password2' %}
                                <span style="color: #FFD700;">‚úì</span> Confirm Password
                            {% else %}
                                {{ field.label }}
                            {% endif %}
                        </label>
                        
                        <div style="position: relative;">
                            {{ field }}
                            {% if 'password' in field.name %}
                            <button type="button" 
                                    onclick="togglePasswordVisibility('{{ field.id_for_label }}')"
                                    style="
                                        position: absolute;
                                        right: 12px;
                                        top: 50%;
                                        transform: translateY(-50%);
                                        background: none;
                                        border: none;
                                        color: #006747;
                                        cursor: pointer;
                                        font-size: 1.2rem;
                                        padding: 0;
                                        width: 24px;
                                        height: 24px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                    ">
                                üëÅÔ∏è
                            </button>
                            {% endif %}
                        </div>
                        
                        {% if field.help_text %}
                        <p style="
                            color: #2F4F4F;
                            font-size: 0.85rem;
                            margin-top: 0.5rem;
                            opacity: 0.7;
                            line-height: 1.4;
                        ">
                            {{ field.help_text|safe }}
                        </p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Password Strength Meter -->
                <div style="
                    background-color: #F8F9FA;
                    padding: 1.2rem;
                    border-radius: 8px;
                    margin-bottom: 2rem;
                    display: none;
                " id="passwordStrength">
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 0.8rem;
                    ">
                        <span style="
                            color: #006747;
                            font-weight: 600;
                            font-size: 0.9rem;
                        ">Password Strength</span>
                        <span style="
                            color: #2F4F4F;
                            font-weight: 600;
                            font-size: 0.85rem;
                        " id="strengthText">Weak</span>
                    </div>
                    <div style="
                        height: 6px;
                        background-color: #E6E6FA;
                        border-radius: 3px;
                        overflow: hidden;
                    ">
                        <div id="strengthBar" style="
                            height: 100%;
                            width: 0%;
                            background-color: #D32F2F;
                            border-radius: 3px;
                            transition: all 0.3s ease;
                        "></div>
                    </div>
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        margin-top: 0.5rem;
                    ">
                        <span style="
                            color: #D32F2F;
                            font-size: 0.8rem;
                            font-weight: 600;
                        ">Weak</span>
                        <span style="
                            color: #FFD700;
                            font-size: 0.8rem;
                            font-weight: 600;
                        ">Fair</span>
                        <span style="
                            color: #006747;
                            font-size: 0.8rem;
                            font-weight: 600;
                        ">Strong</span>
                    </div>
                </div>
                
                <!-- Submit Button -->
                <button type="submit" 
                        style="
                            width: 100%;
                            background: linear-gradient(135deg, #006747 0%, #00563a 100%);
                            color: white;
                            border: none;
                            padding: 1rem;
                            border-radius: 8px;
                            font-size: 1.1rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 0.8rem;
                        " 
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 103, 71, 0.3)';" 
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                        id="submitBtn">
                    <span>üîê</span>
                    Set Password
                </button>
                
                <!-- Additional Info -->
                <div style="
                    text-align: center;
                    margin-top: 1.5rem;
                    padding-top: 1.5rem;
                    border-top: 1px solid #E6E6FA;
                ">
                    <p style="
                        color: #2F4F4F;
                        font-size: 0.9rem;
                        margin: 0;
                        opacity: 0.8;
                    ">
                        <span style="color: #FFD700;">üí°</span>
                        Your password is encrypted and securely stored
                    </p>
                </div>
            </form>
        </div>
        
        <!-- Back to Login -->
        <div class="fade-in" style="
            text-align: center;
            margin-top: 2rem;
        ">
            <p style="
                color: #2F4F4F;
                font-size: 0.95rem;
            ">
                Remember your password?
                <a href="{% url 'login' %}" style="
                    color: #006747;
                    font-weight: 600;
                    text-decoration: none;
                    margin-left: 0.5rem;
                    transition: color 0.3s ease;
                " onmouseover="this.style.color='#00563a'; this.style.textDecoration='underline';" 
                onmouseout="this.style.color='#006747'; this.style.textDecoration='none';">
                    Sign In
                </a>
            </p>
        </div>
    </div>
</div>

<!-- JavaScript for Enhanced Functionality -->
<script>
    // Style form inputs
    document.addEventListener('DOMContentLoaded', function() {
        // Get all password fields
        const passwordFields = document.querySelectorAll('input[type="password"], input[type="text"]');
        
        passwordFields.forEach(field => {
            // Add styling to Django form inputs
            field.style.width = '100%';
            field.style.padding = '0.8rem 3rem 0.8rem 1rem';
            field.style.border = '2px solid #E6E6FA';
            field.style.borderRadius = '8px';
            field.style.fontSize = '1rem';
            field.style.color = '#2F4F4F';
            field.style.backgroundColor = 'white';
            field.style.transition = 'all 0.3s ease';
            field.style.boxSizing = 'border-box';
            
            // Add focus and blur effects
            field.addEventListener('focus', function() {
                this.style.borderColor = '#006747';
                this.style.boxShadow = '0 0 0 3px rgba(0, 103, 71, 0.1)';
            });
            
            field.addEventListener('blur', function() {
                this.style.borderColor = '#E6E6FA';
                this.style.boxShadow = 'none';
            });
        });
        
        // Password strength checker
        const newPasswordField = document.querySelector('input[name="new_password1"]');
        const confirmPasswordField = document.querySelector('input[name="new_password2"]');
        const strengthMeter = document.getElementById('passwordStrength');
        const strengthBar = document.getElementById('strengthBar');
        const strengthText = document.getElementById('strengthText');
        const submitBtn = document.getElementById('submitBtn');
        
        if (newPasswordField) {
            newPasswordField.addEventListener('input', function() {
                const password = this.value;
                const strength = calculatePasswordStrength(password);
                
                // Show/hide strength meter
                if (password.length > 0) {
                    strengthMeter.style.display = 'block';
                    
                    // Update strength bar and text
                    strengthBar.style.width = strength.percentage + '%';
                    strengthBar.style.backgroundColor = strength.color;
                    strengthText.textContent = strength.text;
                    strengthText.style.color = strength.color;
                    
                    // Disable submit button for weak passwords
                    if (strength.score < 3) {
                        submitBtn.disabled = true;
                        submitBtn.style.opacity = '0.6';
                        submitBtn.style.cursor = 'not-allowed';
                    } else {
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = '1';
                        submitBtn.style.cursor = 'pointer';
                    }
                } else {
                    strengthMeter.style.display = 'none';
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                    submitBtn.style.cursor = 'pointer';
                }
            });
        }
        
        // Password confirmation check
        if (newPasswordField && confirmPasswordField) {
            confirmPasswordField.addEventListener('input', function() {
                const password = newPasswordField.value;
                const confirm = this.value;
                
                if (confirm.length > 0 && password !== confirm) {
                    this.style.borderColor = '#D32F2F';
                    this.style.backgroundColor = '#FFF0F0';
                } else if (confirm.length > 0) {
                    this.style.borderColor = '#006747';
                    this.style.backgroundColor = '#F0F8F0';
                } else {
                    this.style.borderColor = '#E6E6FA';
                    this.style.backgroundColor = 'white';
                }
            });
        }
    });
    
    function togglePasswordVisibility(fieldId) {
        const field = document.getElementById(fieldId);
        const button = field.nextElementSibling;
        
        if (field.type === 'password') {
            field.type = 'text';
            button.textContent = 'üëÅÔ∏è‚Äçüó®Ô∏è';
        } else {
            field.type = 'password';
            button.textContent = 'üëÅÔ∏è';
        }
    }
    
    function calculatePasswordStrength(password) {
        let score = 0;
        
        // Length check
        if (password.length >= 8) score += 1;
        if (password.length >= 12) score += 1;
        
        // Complexity checks
        if (/[A-Z]/.test(password)) score += 1; // Uppercase
        if (/[a-z]/.test(password)) score += 1; // Lowercase
        if (/[0-9]/.test(password)) score += 1; // Numbers
        if (/[^A-Za-z0-9]/.test(password)) score += 1; // Special chars
        
        // Determine strength level
        let strength = {
            score: score,
            percentage: 0,
            text: 'Weak',
            color: '#D32F2F'
        };
        
        if (score >= 6) {
            strength.percentage = 100;
            strength.text = 'Strong';
            strength.color = '#006747';
        } else if (score >= 4) {
            strength.percentage = 66;
            strength.text = 'Fair';
            strength.color = '#FFD700';
        } else if (score >= 2) {
            strength.percentage = 33;
            strength.text = 'Weak';
            strength.color = '#D32F2F';
        } else {
            strength.percentage = 10;
            strength.text = 'Very Weak';
            strength.color = '#D32F2F';
        }
        
        return strength;
    }
    
    // Form validation
    document.getElementById('passwordForm').addEventListener('submit', function(e) {
        const newPassword = document.querySelector('input[name="new_password1"]').value;
        const confirmPassword = document.querySelector('input[name="new_password2"]').value;
        
        // Check if passwords match
        if (newPassword !== confirmPassword) {
            e.preventDefault();
            alert('Passwords do not match. Please make sure both passwords are identical.');
            document.querySelector('input[name="new_password2"]').focus();
            return false;
        }
        
        // Check password strength
        const strength = calculatePasswordStrength(newPassword);
        if (strength.score < 3) {
            e.preventDefault();
            if (!confirm('Your password is weak. Are you sure you want to use this password?')) {
                document.querySelector('input[name="new_password1"]').focus();
                return false;
            }
        }
        
        return true;
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Tab to navigate between fields
        if (e.key === 'Tab') {
            // This is handled by browser by default
        }
        
        // Ctrl/Cmd + Enter to submit
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            document.getElementById('passwordForm').submit();
        }
        
        // Escape to clear form
        if (e.key === 'Escape') {
            document.getElementById('passwordForm').reset();
        }
    });
</script>

<style>
    /* Responsive Styles */
    @media (max-width: 768px) {
        .password-card {
            padding: 2rem !important;
        }
        
        .logo-container {
            width: 60px !important;
            height: 60px !important;
            font-size: 1.8rem !important;
        }
        
        h1 {
            font-size: 1.8rem !important;
        }
    }
    
    @media (max-width: 480px) {
        .password-card {
            padding: 1.5rem !important;
        }
        
        .requirements-box {
            padding: 1rem !important;
        }
        
        h1 {
            font-size: 1.6rem !important;
        }
    }
    
    /* Password strength bar animation */
    @keyframes strengthFill {
        from { width: 0%; }
        to { width: var(--target-width); }
    }
    
    /* Input focus animation */
    @keyframes inputFocus {
        0% { box-shadow: 0 0 0 0 rgba(0, 103, 71, 0); }
        50% { box-shadow: 0 0 0 3px rgba(0, 103, 71, 0.2); }
        100% { box-shadow: 0 0 0 3px rgba(0, 103, 71, 0.1); }
    }
    
    /* Submit button loading state */
    .submit-loading {
        position: relative;
        pointer-events: none;
        opacity: 0.7;
    }
    
    .submit-loading::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        top: 50%;
        left: 50%;
        margin: -10px 0 0 -10px;
        border: 2px solid white;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Fade in animation for page */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
        animation: fadeIn 0.5s ease-out;
    }
    
    /* Scale in animation for card */
    @keyframes scaleIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
    
    .scale-in {
        animation: scaleIn 0.4s ease-out;
    }
    
    /* Print styles */
    @media print {
        .password-card {
            box-shadow: none !important;
            border: 1px solid #ddd !important;
        }
        
        button,
        .requirements-box,
        .strength-meter {
            display: none !important;
        }
    }
</style>
{% endblock %}